---
title: 沉浸式改造下预渲染前后闪屏问题
date: 2024-10-010
author: XiaoChen
category: frontend
tags:
  - Vue
---

> 预渲染是服务端数据返回前页面的默认渲染，数据返回后完成真实渲染。

## 背景

在App大于17.2时，各个页面头部做沉浸式改造，优化用户体验。

在做安卓沉浸式改造时，通过`window.user.navigator`获取状态栏的高度，再给body下追加一个--top属性，值即为状态栏的高度。Vue组件中通过dom原生方法拿到标签下--top属性的值，即状态栏的高度值，再追加给Header组件的margin值即可纵向布局不变。

经测试大部分页面可行，但个别页面会产生进入页面预渲染到完成后出现屏幕短暂白屏闪烁的bug。

## 原因

经排查发现，是预渲染导致的：因为苹果是自带沉浸式而安卓不是，原逻辑中在还原设计稿时安卓把预渲染完成后的头部组件的高度在设计稿高度的基准下减少了一些，即判断当前系统，ios给400px，安卓给360px。而预渲染时头部组件的高度是360px，这就导致预渲染结束后高度值变少了，从而导致了闪屏。

## 解决方案

失败方案：最开始我想着在预渲染组件中通过获取App版本的钩子判断当前版本是否大于17.2，如果是，就把预渲染组件的头部高度保持和预渲染后的一样，即减去状态栏的高度：`cal(头部高度 - var(--top))`，但是测试发现并未解决。排查发现在预渲染时，是直接读取打包后的html和css，此时发不通任何服务端接口交易，相当于判断App版本的钩子根本未执行，所以才bug依旧存在。

成功方案：于是我想着既然预渲染时的高度是动不了了，因为如果减去高度后，又会和ios预渲染后的头部高度（设计稿的默认高度）有冲突，所以只能动预渲染完成后的头部高度。
我把安卓预渲染完成后的头部高度改成和预渲染时的400px一样

## 总结
