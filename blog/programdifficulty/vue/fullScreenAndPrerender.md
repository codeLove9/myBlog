---
title: 沉浸式改造下预渲染前后闪屏问题
date: 2024-10-010
author: XiaoChen
category: frontend
tags:
  - Vue
---

> 预渲染是服务端数据返回前页面的默认渲染，数据返回后完成真实渲染。

## 背景

在App大于17.2时，各个页面头部做沉浸式改造，优化用户体验。

在做安卓沉浸式改造时，通过`window.user.navigator`获取状态栏的高度，再给body下追加一个--top属性，值即为状态栏的高度。Vue组件中通过dom原生方法拿到标签下--top属性的值，即状态栏的高度值，再追加给Header组件的margin值即可纵向布局不变。

经测试大部分页面可行，但个别页面会产生进入页面预渲染到完成后出现屏幕短暂白屏闪烁的bug。

## 原因

经排查发现，是预渲染导致的：由于安卓做沉浸式后，没有了黑色状态栏的高度，所以需要增加一些高度值。用getVersion钩子判断是否是沉浸式版本，从而给头部组件不同的高度值。但是排查发现在预渲染时，是直接读取打包后的html和css，此时发不通任何服务端接口交易，相当于判断App版本的钩子根本未执行，默认走的兜底值false即非沉浸式的高度，等预渲染完成后，交易突然发通了钩子返回true走了沉浸式的高度，高度值增加，所以导致前后高度不一致，从而出现闪屏。

## 解决方案

舍弃的牺牲方案：最开始我想着在预渲染组件中通过获取App版本的钩子判断当前版本是否大于17.2，如果是，就把预渲染组件的头部高度保持和预渲染后的一样，即减去状态栏的高度：`cal(头部高度 - var(--top))`，但是测试发现并未解决。排查发现在预渲染时，是直接读取打包后的html和css，此时发不通任何服务端接口交易，相当于判断App版本的钩子根本未执行，所以才bug依旧存在。

正确方案：于是我想着既然预渲染时的高度是动不了了，因为如果减去高度后，又会和ios预渲染后的头部高度（设计稿的默认高度）有冲突，所以只能动预渲染完成后的头部高度。
我把安卓预渲染完成后的头部高度改成和预渲染时的400px一样

## 总结
